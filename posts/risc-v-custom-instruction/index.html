<!doctype html><html><head><title>Adding Custom Instructions to the RISC-V GNU-GCC toolchain</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/layouts/main.css><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/navigators/navbar.css><link href="https://fonts.googleapis.com/css2?family=Muli:wght@300;400;500;600" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css><link rel=icon type=image/png href=/images/site/main-logo_hu75fb5c2f47914ec8a5c4c924b7aa442b_20884_42x0_resize_box_2.png><link rel=stylesheet href=/css/style.css><meta name=description content="Adding Custom Instructions to the RISC-V GNU-GCC toolchain"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/atom-one-dark.min.css><link rel=stylesheet href=/css/layouts/single.css><link rel=stylesheet href=/css/navigators/sidebar.css><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-153830531-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body data-spy=scroll data-target=#TableOfContents data-offset=80><div class="container-fluid bg-dimmed wrapper"><nav class="navbar navbar-expand-xl top-navbar final-navbar shadow"><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button onclick=toggleSidebar()>
<span class=navbar-toggler-icon></span></button>
<a class=navbar-brand href=/><img src=/images/site/main-logo_hu75fb5c2f47914ec8a5c4c924b7aa442b_20884_42x0_resize_box_2.png>Hadi Sandid</a>
<button class="navbar-toggler navbar-light" id=toc-toggler type=button onclick=toggleTOC()>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse lang-selector" id=top-nav-items><ul class="navbar-nav ml-auto"></ul></div></div><img src=/images/site/main-logo_hu75fb5c2f47914ec8a5c4c924b7aa442b_20884_42x0_resize_box_2.png class=d-none id=main-logo>
<img src=/images/site/main-logo_hu75fb5c2f47914ec8a5c4c924b7aa442b_20884_42x0_resize_box_2.png class=d-none id=inverted-logo></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><input type=text placeholder=Search data-search id=search-box><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/posts data-filter=all>Posts</a></li><div class=subtree><li><a href=/posts/hiking-around-lebanon/>Hiking around Lebanon</a></li><li><a href=/posts/game-dev/>Source Engine & Game Design</a></li><li><a class=active href=/posts/risc-v-custom-instruction/>Adding Custom Instructions to the RISC-V GNU-GCC toolchain</a></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(https://hsandid.github.io/posts/risc-v-custom-instruction/hero.png)></div><div class=page-content><div class="author-profile ml-auto align-self-lg-center"><img class=rounded-circle src=/images/author/hadi.PNG><h5 class=author-name>Hadi Sandid</h5><p>January 27, 2021</p></div><div class=title><h1>Adding Custom Instructions to the RISC-V GNU-GCC toolchain</h1></div><div class=post-content id=post-content><ul><li>This tutorial is an updated version of Nitish Srivastava&rsquo;s tutorial <a href=https://nitish2112.github.io/post/adding-instruction-riscv/>Adding custom instruction to RISCV ISA and running it on gem5 and spike</a>.</li><li>I&rsquo;ve also used some tips Jim Wilson gave on the following <a href=https://groups.google.com/a/groups.riscv.org/g/sw-dev/c/sL_OHXYj3LY/m/Gsm6sBc9BQAJ>mailing list</a>.</li></ul><h3 id=installing-the-risc-v-gnugcc-toolchain>Installing the RISC-V GNU/GCC toolchain</h3><p>We will be building the RISC-V GNU/GCC RV64GC Newlib Cross-compiler on an Ubuntu machine. If you&rsquo;d like to use another configuration; you can check the repository instructions <a href=https://github.com/riscv/riscv-gnu-toolchain>here</a>.</p><ul><li>Clone the RISC-V GNU/GCC toolchain, along with its submodules (7GB download) :</li></ul><pre><code>$ git clone https://github.com/riscv/riscv-gnu-toolchain.git
$ git submodule update --init --recursive
</code></pre><ul><li>Install the pre-requisites for the RISC-V GNU/GCC toolchain (Ubuntu) :</li></ul><pre><code>$ sudo apt-get install autoconf automake autotools-dev curl python3 libmpc-dev libmpfr-dev libgmp-dev gawk build-essential bison flex texinfo gperf libtool patchutils bc zlib1g-dev libexpat-dev
</code></pre><ul><li>Build the RISC-V GNU/GCC Newlib Cross-compiler :</li></ul><pre><code>./configure --prefix=&lt;installation_path&gt;
make
</code></pre><h3 id=cloning-the-risc-v-opcodes-tool>Cloning the RISC-V Opcodes Tool</h3><ul><li>Clone the RISC-V Opcodes Tool :</li></ul><pre><code>$ git clone https://github.com/riscv/riscv-opcodes
</code></pre><h3 id=defining-our-instruction>Defining our Instruction</h3><ul><li>We&rsquo;d like to add a &ldquo;modulo&rdquo; instruction to the ISA. The instruction and its semantics are given below :</li></ul><pre><code>mod r1, r2, r3

Semantics:
R[r1] = R[r2] % R[r3]
</code></pre><ul><li>In the root folder of the RISC-V Opcodes Tool, you can see different files, each pertaining to a set of RISC-V opcodes.</li></ul><p><img src=/images/posts/risc-v-custom/risc-v-custom-6.jpeg alt="Risc-v custom"></p><ul><li>Add your &ldquo;modulo&rdquo; instruction to one of the opcodes-xxx files available in your repository :</li></ul><pre><code>mod     rd rs1 rs2 31..25=1  14..12=0 6..2=0x1A 1..0=3
</code></pre><ul><li>Run the following command to generate the MATCH and MASK hexadecimal values for your instruction :</li></ul><pre><code>cat &lt;opcodes-file-you-modified&gt; | ./parse-opcodes -c &gt; instructionInfo.h
</code></pre><ul><li>Open the instructionInfo.h file, and you will find the following lines :</li></ul><pre><code>#define MATCH_MOD 0x200006b                                                    
#define MASK_MOD 0xfe00707f
...
DECLARE_INSN(mod, MATCH_MOD, MASK_MOD)
</code></pre><p>The MASK hexadecimal value is also a 32-bit hex, which puts a &lsquo;mask&rsquo; telling where all fields that are associated with your instruction&rsquo;s type. For example, <code>mod</code> is an R-type instruction with the following hexadecimal mask : <code>0xfe00707f</code></p><p>The MATCH hexadecimal value is basically a 32-bit hex where the value of your opcodes/funct3/funct7 are set to define your instruction. For example; <code>mod</code> has a hexadecimal match of <code>0x200006b</code>; which means that in binary we have<code>funct7 = 0b0010000</code>; <code>funct3 = 0b000</code> and <code>opcode = 0b1101011</code>.</p><p>You can use the RISC-V green card to check the MASK and MATCH fields are correct by determining their hex value by-hand. The RISC-V green card can be found <a href=https://inst.eecs.berkeley.edu//~cs61c/fa17/img/riscvcard.pdf>here</a>.</p><p><img src=/images/posts/risc-v-custom/risc-v-custom-7.jpeg alt="Risc-v custom"></p><h3 id=modifying-the-risc-v-gnugcc-binutils>Modifying the RISC-V GNU/GCC Binutils</h3><ul><li>Since modifying the GCC compiler itself would prove too complex; we will modify the RISC-V GNU/GCC Binutils to add an additional instruction.</li><li>First, we look into riscv-gnu-toolchain/riscv-binutils-gdb/include/opcode/riscv-opc.h; where we will add the <code>#define</code> and <code>DECLARE_INSN()</code> elements we generated for our instruction in the appropriate blocks :</li></ul><p>Adding the <code>#define</code> :</p><p><img src=/images/posts/risc-v-custom/risc-v-custom-1.png alt="Risc-v custom"></p><p>Adding the <code>DECLARE_INSN()</code> :</p><p><img src=/images/posts/risc-v-custom/risc-v-custom-2.png alt="Risc-v custom"></p><p>Make sure to plug your modifications are the right place, or you WILL break the assembler !</p><ul><li>Second, we look into the riscv-gnu-toolchain/riscv-binutils-gdb/opcodes/riscv-opc.c file</li></ul><p>We need to declare our instruction using a specific set of parameters :</p><p><img src=/images/posts/risc-v-custom/risc-v-custom-3.png alt="Risc-v custom"></p><p><em>name</em> : self-explanatory, just give your desired instruction&rsquo;s name</p><p><em>xlen</em>: specify the width of an integer register in bits (0,32,64)</p><p><em>ISA</em> : declare the type of instruction used. You can find more details on the different instruction directives in the same file if you scroll down</p><p><img src=/images/posts/risc-v-custom/risc-v-custom-4.png alt="Risc-v custom"></p><p><em>operands</em> : The function handling operands is available in riscv-binutils/gas/config/tc-riscv.c. Check it out to check which characters must be used to represent your operands.</p><p><img src=/images/posts/risc-v-custom/risc-v-custom-8.jpeg alt="Risc-v custom"></p><p>This is the parsing function riscv_ip()&rsquo;s main switch statement which handles the different operands. It&rsquo;s located somewhere on Line 2000. Once you get the char values associated with your operands of choice, you plug them in the instruction definition here</p><p><em>match</em> : Use the MATCH value declared before for our custom instruction.</p><p><em>mask</em> : Use the MASK value declared before for our custom instruction.</p><p><em>match_opcode</em> : Pointer to the function you&rsquo;d like to use to &lsquo;detect&rsquo; which opcode you are using. Haven&rsquo;t experimented with it yet (<em>Edit : This definition might be incorrect</em>)</p><p><em>pinfo</em> : Used to specify some special behavior. Mainly used with branch instructions and compressed RISC-V instructions. It&rsquo;s set to 0 if there is no special behavior</p><h3 id=re-building--testing-our-custom-instruction>Re-building & Testing our custom instruction</h3><ul><li>Rebuild the RISC-V GNU/GCC Compiler Toolchain, as we did in the first steps, and you should now be able to use your custom instructions in your programs. To be able to invoke your custom instruction, you should use inline assembly.</li><li>Here is an example of C code using inline assembly to invoke a custom instruction:</li></ul><p><img src=/images/posts/risc-v-custom/risc-v-custom-5.jpeg alt="Risc-v custom"></p><ul><li><p>Finally, RISC-V instructions are assembled into machine code. You can use &lsquo;obj-dump&rsquo; to check the generated RISC-V binaries, and check where your custom instruction is invoked.</p></li><li><p>We have not implemented any logic related to the instruction in here. Logic needs to be implemented on the simulator side, meaning that if you&rsquo;d like your custom instruction to work with SPIKE or gem5; you&rsquo;d have to modify them and add the logic associated with your custom instruction manually.</p></li></ul></div><div class=btn-improve-page><a href=https://github.com/hsandid/hsandid.github.io/edit/main/content/posts/risc-v-custom-instruction/index.md><i class="fas fa-code-branch"></i>Improve this page</a></div><hr><div class="row next-prev-navigator"><div class="col-md-12 next-article"><a href=/posts/game-dev/ class="btn btn-outline-info"><span>Next <i class="fas fa-chevron-circle-right"></i></span><br><span>Source Engine & Game Design</span></a></div></div><hr><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname=="localhost")return;var dsq=document.createElement("script");dsq.type="text/javascript";dsq.async=true;var disqus_shortname="https-hsandid-github-io-disqus-com";dsq.src="//"+disqus_shortname+".disqus.com/embed.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(dsq);})();</script><noscript>Please enable JavaScript to view the
<a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center pl-3">Table of Contents</h5><hr><div class=toc><nav id=TableOfContents><ul><li><ul><li><a href=#installing-the-risc-v-gnugcc-toolchain>Installing the RISC-V GNU/GCC toolchain</a></li><li><a href=#cloning-the-risc-v-opcodes-tool>Cloning the RISC-V Opcodes Tool</a></li><li><a href=#defining-our-instruction>Defining our Instruction</a></li><li><a href=#modifying-the-risc-v-gnugcc-binutils>Modifying the RISC-V GNU/GCC Binutils</a></li><li><a href=#re-building--testing-our-custom-instruction>Re-building & Testing our custom instruction</a></li></ul></li></ul></nav></div></div></section></div><footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-left"><div class="col-md-4 col-sm-12"><h5>Navigation</h5><ul><li class=nav-item><a class=smooth-scroll href=#about>About</a></li><li class=nav-item><a class=smooth-scroll href=#skills>Skills</a></li><li class=nav-item><a class=smooth-scroll href=#experiences>Experience</a></li><li class=nav-item><a class=smooth-scroll href=#education>Education</a></li><li class=nav-item><a class=smooth-scroll href=#projects>Projects</a></li><li class=nav-item><a class=smooth-scroll href=#recent-posts>Recent Posts</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>Contact me:</h5><ul><li><span>Email:</span> <span>hadisandid@gmail.com</span></li></ul></div></div></div><hr><div class=container><div class="row text-left"><div class=col-md-4><a id=theme href=https://github.com/hossainemruz/toha target=#><img src=/images/theme-logo_hu8376fd15465fef26ffe66b6bcf0ca686_13669_32x0_resize_box_2.png>
Toha</a></div><div class="col-md-4 text-center">Â© 2020 Copyright.</div><div class="col-md-4 text-right"><a id=hugo href=https://gohugo.io/>Powered by
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script src=/js/jquery-3.4.1.min.js></script><script src=/js/popper.min.js></script><script src=/js/bootstrap.min.js></script><script src=/js/navbar.js></script><script src=/js/main.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js></script><script src=/js/single.js></script><script>hljs.initHighlightingOnLoad();</script></body></html>